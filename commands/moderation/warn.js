/*
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚£ø‚£ø‚†Ä‚†Ä‚†Ä‚¢†‚£æ‚£ß‚£§‚°ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£º‚†ã‚†Ä‚†â‚†Ä‚¢Ñ‚£∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£•‚°§‚¢∂‚£ø‚£¶‚£Ä‚°Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£ø‚°Ü‚†Ä‚†Ä‚†Ä‚£ô‚£õ‚£ø‚£ø‚£ø‚£ø‚°è‚†Ä‚†Ä‚£Ä‚£ø‚£ø‚£ø‚°ü
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†ª‚†∑‚£¶‚£§‚£§‚£¨‚£Ω‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ü‚†õ‚†ø‚†ã‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£¥‚†ã‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚¢ø‚£ø‚£ø‚°Ü‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚£∂‚£∂‚£∂‚£ø‚£¶‚°Ä‚†ò‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ø‚†ã‚†à‚¢π‚°è‚†Å‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢Ä‚£ø‚°è‚†â‚†ø‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚°Ü‚†Ä‚¢Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ü‚°ò‚£ø‚£ø‚£É‚†Ä‚†Ä‚†Ä
‚£¥‚£∑‚£Ä‚£∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£ø‚£ø‚£ø‚£ø‚†π‚£ø‚£Ø‚£§‚£æ‚†è‚†â‚†â‚†â‚†ô‚†¢‚†Ä
‚†à‚†ô‚¢ø‚£ø‚°ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚£ø‚£ø‚£ø‚£Ñ‚†õ‚†â‚¢©‚£∑‚£¥‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£ø‚£ø‚£ø‚£ø‚£Ä‚°†‚†ã‚†à‚¢ø‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†ø‚†ø‚†õ‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä

--------------------------------------------
üëë Owner    : Enzzyx
üì° Discord  : https://discord.gg/QYVcWZbBp
üõ†Ô∏è Studio   : Hazz Wave Studio
‚úÖ Verified | üß© Flexible | ‚öôÔ∏è Stable
--------------------------------------------
> ¬© 2026 Enzzyx || Hazz Wave Studio || Slavy
--------------------------------------------
*/

const { SlashCommandBuilder, PermissionFlagsBits, EmbedBuilder } = require('discord.js');
const Warning = require('../../models/Warning'); 
const { sendLog } = require('../../utils/logger');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('warn')
        .setDescription('‚ÄºÔ∏è Provide warnings to members')
        .addUserOption(option => option.setName('target').setDescription('Member who will be warned').setRequired(true))
        .addStringOption(option => option.setName('reason').setDescription('Reason for warning').setRequired(false))
        .setDefaultMemberPermissions(PermissionFlagsBits.ModerateMembers),

    async execute(interaction) {
        await interaction.deferReply();
        
        const target = interaction.options.getUser('target');
        const reason = interaction.options.getString('reason') || 'No reason provided';
        const guildId = interaction.guild.id;
        const targetMember = await interaction.guild.members.fetch(target.id).catch(() => null);

        // Security Validation: Anti-Bot
        if (target.bot) {
            return interaction.editReply({ 
                embeds: [new EmbedBuilder().setColor('#ff4757').setDescription('‚ùå You cannot give a warning to a bot!')] 
            });
        }
        
        // Security Validation: Anti-Self
        if (target.id === interaction.user.id) {
            return interaction.editReply({ 
                embeds: [new EmbedBuilder().setColor('#ff4757').setDescription('‚ùå You cannot warn yourself!')] 
            });
        }

        // Security Validation: Role Hierarchy
        if (targetMember && targetMember.roles.highest.position >= interaction.member.roles.highest.position) {
            return interaction.editReply({ 
                embeds: [new EmbedBuilder().setColor('#ff4757').setDescription('‚ùå You cannot warn this member because they have a higher or equal role position!')] 
            });
        }

        try {
            // Look for the user warning data in MongoDB
            let warnData = await Warning.findOne({ guildId, userId: target.id });

            if (!warnData) {
                warnData = new Warning({
                    guildId,
                    userId: target.id,
                    warns: []
                });
            }

            // Add new warning entry
            warnData.warns.push({
                moderatorId: interaction.user.id,
                reason: reason,
                timestamp: Date.now()
            });

            await warnData.save();

            const warnCount = warnData.warns.length;

            // Luxury Embed Construction
            const warnEmbed = new EmbedBuilder()
                .setTitle('üõ°Ô∏è Moderation Action: WARNING SYSTEM')
                .setColor('#f39c12')
                .setThumbnail(target.displayAvatarURL())
                .addFields(
                    { name: 'üë§ Target', value: `${target.tag}`, inline: true },
                    { name: 'üî¢ Total Warns', value: `**${warnCount}**`, inline: true },
                    { name: 'üëÆ Moderator', value: `${interaction.user.tag}`, inline: false },
                    { name: 'üìÑ Reason', value: `\`\`\`${reason}\`\`\``, inline: false }
                )
                .setFooter({ text: `Slavy Security System ‚Ä¢ Warning Logged` })
                .setTimestamp();

            // Send report to the configured logging channel
            await sendLog(interaction.guild, warnEmbed);

            // Attempt to notify the target via Direct Message
            try {
                await target.send({
                    content: `‚ö†Ô∏è You have received a warning in **${interaction.guild.name}**`,
                    embeds: [warnEmbed]
                });
            } catch (err) {
                // If DM fails, we update the footer but continue the process
                warnEmbed.setFooter({ text: 'Slavy Security System ‚Ä¢ DM Failed (Closed)' });
            }

            await interaction.editReply({ embeds: [warnEmbed] });

        } catch (error) {
            console.error(error);
            interaction.editReply({ 
                embeds: [
                    new EmbedBuilder()
                        .setColor('#ff4757')
                        .setDescription('‚ùå An error occurred while accessing the database.')
                ] 
            });
        }
    }
};