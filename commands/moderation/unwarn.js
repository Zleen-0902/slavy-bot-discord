/*
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚£ø‚£ø‚†Ä‚†Ä‚†Ä‚¢†‚£æ‚£ß‚£§‚°ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£º‚†ã‚†Ä‚†â‚†Ä‚¢Ñ‚£∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£•‚°§‚¢∂‚£ø‚£¶‚£Ä‚°Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£ø‚°Ü‚†Ä‚†Ä‚†Ä‚£ô‚£õ‚£ø‚£ø‚£ø‚£ø‚°è‚†Ä‚†Ä‚£Ä‚£ø‚£ø‚£ø‚°ü
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†ª‚†∑‚£¶‚£§‚£§‚£¨‚£Ω‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ü‚†õ‚†ø‚†ã‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£¥‚†ã‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚¢ø‚£ø‚£ø‚°Ü‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚£∂‚£∂‚£∂‚£ø‚£¶‚°Ä‚†ò‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ø‚†ã‚†à‚¢π‚°è‚†Å‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢Ä‚£ø‚°è‚†â‚†ø‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚°Ü‚†Ä‚¢Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ü‚°ò‚£ø‚£ø‚£É‚†Ä‚†Ä‚†Ä
‚£¥‚£∑‚£Ä‚£∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£ø‚£ø‚£ø‚£ø‚†π‚£ø‚£Ø‚£§‚£æ‚†è‚†â‚†â‚†â‚†ô‚†¢‚†Ä
‚†à‚†ô‚¢ø‚£ø‚°ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚£ø‚£ø‚£ø‚£Ñ‚†õ‚†â‚¢©‚£∑‚£¥‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£ø‚£ø‚£ø‚£ø‚£Ä‚°†‚†ã‚†à‚¢ø‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†ø‚†ø‚†õ‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä

--------------------------------------------
üëë Owner    : Enzzyx
üì° Discord  : https://discord.gg/QYVcWZbBp
üõ†Ô∏è Studio   : Hazz Wave Studio
‚úÖ Verified | üß© Flexible | ‚öôÔ∏è Stable
--------------------------------------------
> ¬© 2026 Enzzyx || Hazz Wave Studio || Slavy
--------------------------------------------
*/

const { SlashCommandBuilder, PermissionFlagsBits, EmbedBuilder } = require('discord.js');
const Warning = require('../../models/Warning');
const { sendLog } = require('../../utils/logger');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('unwarn')
        .setDescription('üõ°Ô∏è Remove warning points from members')
        .addUserOption(option => option.setName('target').setDescription('Members who will be unwarned').setRequired(true))
        .addStringOption(option => 
            option.setName('mode')
                .setDescription('Select deletion method')
                .setRequired(true)
                .addChoices(
                    { name: 'Remove Latest (Delete Latest)', value: 'latest' },
                    { name: 'Clear All (Delete All)', value: 'all' }
                ))
        .addStringOption(option => option.setName('reason').setDescription('Reason for deletion').setRequired(false))
        .setDefaultMemberPermissions(PermissionFlagsBits.ModerateMembers),

    async execute(interaction) {
    await interaction.deferReply();
        const target = interaction.options.getUser('target');
        const mode = interaction.options.getString('mode');
        const reason = interaction.options.getString('reason') || 'No reason provided';
        const guildId = interaction.guild.id;

        try {
            const warnData = await Warning.findOne({ guildId, userId: target.id });

            if (!warnData || warnData.warns.length === 0) {
                return interaction.editReply({ 
                    embeds: [
                        new EmbedBuilder()
                            .setColor('#ff4757')
                            .setDescription('‚ùå This user has no warning history in the database.')
                    ] 
                });
            }

            let description = "";

            if (mode === 'latest') {
                // Remove one last warning
                warnData.warns.pop();
                description = `Successfully removed the latest warning for **${target.tag}**.`;
            } else if (mode === 'all') {
                // Remove all array warns
                warnData.warns = [];
                description = `Successfully cleared all warnings for **${target.tag}**.`;
            }

            await warnData.save();

            // Luxury Embed Unwarn Results
            const unwarnEmbed = new EmbedBuilder()
                .setTitle('üõ°Ô∏è Moderation Action: UNWARNED')
                .setColor('#2ecc71')
                .setThumbnail(target.displayAvatarURL())
                .addFields(
                    { name: 'üë§ Target', value: `${target.tag}`, inline: true },
                    { name: 'üî¢ Remaining Warns', value: `**${warnData.warns.length}**`, inline: true },
                    { name: 'üëÆ Moderator', value: `${interaction.user.tag}`, inline: false },
                    { name: 'üìÑ Reason', value: `\`\`\`${reason}\`\`\``, inline: false }
                )
                .setDescription(description)
                .setFooter({ text: `Slavy Security System ‚Ä¢ Database Updated` })
                .setTimestamp();

            // Send report to channel log
            await sendLog(interaction.guild, unwarnEmbed);

            // Notify the user via DM
            try {
                await target.send({
                    content: `‚ú® Your warning status in **${interaction.guild.name}** has been updated.`,
                    embeds: [unwarnEmbed]
                });
            } catch (err) {
                unwarnEmbed.setFooter({ text: 'Slavy Security System ‚Ä¢ DM Failed (Closed)' });
            }

            await interaction.editReply({ embeds: [unwarnEmbed] });

        } catch (error) {
            console.error(error);
            interaction.editReply({ 
                embeds: [
                    new EmbedBuilder()
                        .setColor('#ff4757')
                        .setDescription('‚ùå An error occurred while updating the database.')
                ] 
            });
        }
    }
};