/*
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚£ø‚£ø‚†Ä‚†Ä‚†Ä‚¢†‚£æ‚£ß‚£§‚°ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£º‚†ã‚†Ä‚†â‚†Ä‚¢Ñ‚£∏‚£ø‚£ø‚£ø‚£ø‚£ø‚£•‚°§‚¢∂‚£ø‚£¶‚£Ä‚°Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ø‚£ø‚°Ü‚†Ä‚†Ä‚†Ä‚£ô‚£õ‚£ø‚£ø‚£ø‚£ø‚°è‚†Ä‚†Ä‚£Ä‚£ø‚£ø‚£ø‚°ü
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†ª‚†∑‚£¶‚£§‚£§‚£¨‚£Ω‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ü‚†õ‚†ø‚†ã‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£¥‚†ã‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚¢ø‚£ø‚£ø‚°Ü‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚£∂‚£∂‚£∂‚£ø‚£¶‚°Ä‚†ò‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†ø‚†ã‚†à‚¢π‚°è‚†Å‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢Ä‚£ø‚°è‚†â‚†ø‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚°Ü‚†Ä‚¢Ä‚£ø‚°á‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ü‚°ò‚£ø‚£ø‚£É‚†Ä‚†Ä‚†Ä
‚£¥‚£∑‚£Ä‚£∏‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£ø‚£ø‚£ø‚£ø‚†π‚£ø‚£Ø‚£§‚£æ‚†è‚†â‚†â‚†â‚†ô‚†¢‚†Ä
‚†à‚†ô‚¢ø‚£ø‚°ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚£ø‚£ø‚£ø‚£Ñ‚†õ‚†â‚¢©‚£∑‚£¥‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£ø‚£ø‚£ø‚£ø‚£Ä‚°†‚†ã‚†à‚¢ø‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†ø‚†ø‚†õ‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä

--------------------------------------------
üëë Owner    : Enzzyx
üì° Discord  : https://discord.gg/QYVcWZbBp
üõ†Ô∏è Studio   : Hazz Wave Studio
‚úÖ Verified | üß© Flexible | ‚öôÔ∏è Stable
--------------------------------------------
> ¬© 2026 Enzzyx || Hazz Wave Studio || Slavy
--------------------------------------------
*/

const { SlashCommandBuilder, EmbedBuilder, PermissionFlagsBits, MessageFlags } = require('discord.js');
const Sticky = require('../../models/Sticky'); 

module.exports = {
    data: new SlashCommandBuilder()
        .setName('stickyembed')
        .setDescription('üí≠ Enable sticky messages in Embed format (premium)')
        .addStringOption(opt => 
            opt.setName('description')
                .setDescription('Main content of the message (use \\n for new line)')
                .setRequired(true))
        .addStringOption(opt => 
            opt.setName('title')
                .setDescription('Title at the top of the embed'))
        .addStringOption(opt => 
            opt.setName('thumbnail')
                .setDescription('URL Image for thumbnail (optional)'))
        .addStringOption(opt => 
            opt.setName('color')
                .setDescription('Color Hex Code (Example: #ff0000 for Red)'))
        .setDefaultMemberPermissions(PermissionFlagsBits.ManageMessages), 

    async execute(interaction) {
        await interaction.deferReply({ flags: [MessageFlags.Ephemeral] });

        const description = interaction.options.getString('description').replace(/\\n/g, '\n');
        const title = interaction.options.getString('title') || 'üìå STICKY EMBED';
        const thumbnail = interaction.options.getString('thumbnail');
        const color = interaction.options.getString('color') || '#00ff99';

        // Simple Hex color validation
        const hexRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
        const finalColor = hexRegex.test(color) ? color : '#00ff99';

        try {
            // Embed data preparation
            const embedData = {
                title: title,
                description: description,
                color: parseInt(finalColor.replace('#', ''), 16),
                footer: { text: `Server: ${interaction.guild.name}` },
                timestamp: new Date()
            };

            // If there is a thumbnail, insert it into the object
            if (thumbnail && thumbnail.startsWith('http')) {
                embedData.thumbnail = { url: thumbnail };
            }

            await Sticky.findOneAndUpdate(
                { guildId: interaction.guildId },
                { 
                    channelId: interaction.channelId,
                    content: JSON.stringify(embedData), 
                    isEmbed: true,
                    lastMessageId: null 
                },
                { upsert: true, new: true }
            );

            // Preview for Admin using the same data
            const previewEmbed = new EmbedBuilder(embedData);

            return interaction.editReply({
                content: `‚úÖ **Sticky Embed Successfully Activated!**`,
                embeds: [previewEmbed]
            });

        } catch (error) {
            console.error(error);
            return interaction.editReply('‚ùå An error occurred while saving to MongoDB.');
        }
    },
};